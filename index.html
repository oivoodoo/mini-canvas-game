<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <title>Tetris by oivoodoo</title>
    <script type="text/javascript" language="javascript" charset="utf-8" src='scripts/raphael.js'></script>
  </head>

  <body>
    <div id='container'>

    </div>

    <script type="text/javascript" language="javascript" charset="utf-8">
    // <![CDATA[

        var Application = function() {
          var instance = this;
          this.block_size = 40;
          this.container_size = 402;
          this.blocks = [];
          this.numbers = [];
          this.ids = [];
          this.paper = null;
          this.start_drug = false;
          this.current_block = 0;
          this.clear_block = 15;
          this.swap_speed = 1000;

          this.initialize = function() {
            this.paper = new Raphael("container", this.container_size, this.container_size);
            this.randomize_blocks();
          };
          
          this.randomize_blocks = function() {
            var iterator = 1;
            debugger;
            for(var i = 0; i < 4; i++) {
              for(var j = 0; j < 4; j++) {
                var position = -1;
                for(;this.is_exists_block(position);) {
                  position = Math.floor(Math.random() * 16);
                }
                var set = this.create_block(i, j, position);
                this.blocks.push(set);
                this.numbers.push(position);
                iterator += 1;
              }
            }
          };
          
          this.is_exists_block = function(number) {
            for(var i = 0; i < this.numbers.length; i++) {
              if (this.numbers[i] == number) {
                return true;
              }
            }
            return false;
          };

          this.find_block = function(control) {
            // TODO: rewrite method for placing behind the blocks rectangle with opacity.
            for(var i = 0; i < this.blocks.length; i++) {
              if (control.type == "rect" && this.blocks[i][0].id == control.id) {
                return i;
              // Try to check another boxes types
              } else if (this.blocks[i].length > 1 && this.blocks[i][1].id == control.id) {
                return i;
              }
            }
            return -1;
          };

          this.is_complete = function() {
            return false;
          };

          this.show_scores = function() {
            // TODO: Show score dialog with time.
          };

          this.restart_game = function() {
            // TODO: Restart game timer.
            this.initialize();
          };

          this.near_clear_block = function(i) {
            if (this.clear_block == i + 1 ||
                this.clear_block == i - 1 ||
                this.clear_block == i + 4 ||
                this.clear_block == i - 4) {
              return true;
            }
            return false;
          };

          this.get_positions = function(i) {
            if (this.clear_block == i + 1) {
              return {f: [this.block_size, 0], s: [-this.block_size, 0]};
            } else if (this.clear_block == i - 1) {
              return {f: [-this.block_size, 0], s: [this.block_size, 0]};
            } else if (this.clear_block == i + 4) {
              return {f: [0, this.block_size], s: [0, -this.block_size]};
            } else if (this.clear_block == i - 4) {
              return {f: [0, -this.block_size], s: [0, this.block_size]};
            }
          }

          this.swap_blocks = function(i, j) {
            var p = this.get_positions(i);
            var b1 = this.blocks[i];
            var b2 = this.blocks[j];
			
            this.move_block(b1, p['f'][0], p['f'][1]);
            this.move_block(b2, p['s'][0], p['s'][1]);
            
            var block = this.blocks[i];
            this.blocks[i] = this.blocks[j];
            this.blocks[j] = block;
            
            var n = this.numbers[i];
            this.numbers[i] = this.numbers[j];
            this.numbers[j] = n;
          };
		  
          this.move_block = function(bl, x, y) {
            for(var i = 0; i < bl.length; i++) {
              bl[i].animate({
                x: x + bl[i].attrs.x,
                y: y + bl[i].attrs.y
              }, this.swap_speed, ">");
            }
          };

          this.create_block = function(i, j, iterator) {
            var set = this.paper.set();
            if (iterator != 16) {
              set.push(
                this.paper.rect(this.block_size * j,
                                this.block_size * i,
                                this.block_size,
                                this.block_size, 10)
                          .attr({fill: '#9cf', stroke: '#ddd', 'stroke-width': 5}),
                this.paper.text(this.block_size * (j + 1) - this.block_size / 2,
                                this.block_size * (i + 1) - this.block_size / 2,
                                iterator)
                          .attr({"font-family": "Tahoma", "font-size": 18})
              );
            } else {
              set.push(
                this.paper.rect(this.block_size * j,
                                this.block_size * i,
                                this.block_size,
                                this.block_size, 10)
                          .attr({fill: '#9cf', stroke: '#ddd', 'stroke-width': 5})
              );
            };

            set.click(function() {
              var block = instance.find_block(this);
              if (block != -1 && instance.near_clear_block(block)) {
                instance.swap_blocks(block, instance.clear_block);
                instance.clear_block = block;
              }
              if (instance.is_complete()) {
                instance.restart_game();
              }
            });

            set.hover(function() {
              set[1].attr({fill: "red"});
            }, function() {
              set[1].attr({fill: "black"});
            });

            return set;
          }

          this.initialize();

        }

        var application = new Application;

    // ]]>
    </script>

  </body>

</html>

